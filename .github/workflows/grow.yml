name: Grow

on:
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      max_turns:
        description: "Max turns for Codex"
        default: "60"
        type: string
      model:
        description: "Model"
        default: "gpt-5-mini"
        type: choice
        options:
          - gpt-5-mini
          - gpt-5.2-codex
          - gpt-5.1-codex
          - gpt-5-codex
          - gpt-5.2
          - gpt-5.1
          - gpt-5
          - gpt-5-nano

jobs:
  grow:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      id-token: write
    env:
      DEFAULT_MODEL: gpt-5-mini

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: ${{ inputs.model || env.DEFAULT_MODEL }}
          prompt: |
            You are working on the Tasklr project. Read AGENTS.md for the project goal and constraints.

            Read the latest file(s) in updates/ to understand the current state, then decide what to work on next.
            Make incremental progress, test what you can, and create a new sequentially-numbered update file in updates/ when you're done.

            You have approximately ${{ inputs.max_turns || '150' }} turns this run, and the run timeout is set to 30 minutes.
            Budget your work accordingly â€” commit early and often, and write your update file well before you run out.
            Keep track of your turns by outputting the current turn count somewhere in each turn's output.
            Try to finish working with 10 turns to spare.
            Take note of how many turns different updates required, and use that as a gauge for deciding what to work on.
            Be sure to include how many turns you took when writing the update file.

            Commit your changes with a clear commit message.
      - name: Push changes
        run: |
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
          git config user.name "tasklr-bot"
          git config user.email "tasklr-bot@users.noreply.github.com"
          git push
