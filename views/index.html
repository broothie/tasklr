<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasklr</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --indigo: #4f46e5;
      --indigo-dark: #4338ca;
      --indigo-light: #eef2ff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-700: #334155;
      --gray-900: #0f172a;
      --red: #ef4444;
      --green: #22c55e;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      min-height: 100vh;
    }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--indigo);
      letter-spacing: -0.5px;
    }

    .user-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-name {
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .btn-logout {
      background: none;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-logout:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: flex;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
      gap: 24px;
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 240px;
      flex-shrink: 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 0 8px;
    }

    .sidebar-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-400);
    }

    .btn-new-list {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-400);
      padding: 2px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      transition: all 0.15s;
    }

    .btn-new-list:hover {
      color: var(--indigo);
      background: var(--indigo-light);
    }

    .btn-new-list svg {
      width: 16px;
      height: 16px;
    }

    .new-list-form {
      display: none;
      padding: 8px 4px;
      margin-bottom: 4px;
    }

    .new-list-form.visible {
      display: block;
    }

    .new-list-form .input {
      font-size: 0.875rem;
      padding: 8px 10px;
      margin-bottom: 6px;
    }

    .new-list-form-actions {
      display: flex;
      gap: 6px;
    }

    .new-list-form-actions .btn {
      flex: 1;
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--gray-700);
      transition: all 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      position: relative;
    }

    .list-item:hover {
      background: var(--gray-100);
    }

    .list-item.active {
      background: var(--indigo-light);
      color: var(--indigo);
      font-weight: 600;
    }

    .list-icon {
      width: 18px;
      height: 18px;
      opacity: 0.6;
      flex-shrink: 0;
    }

    .list-item.active .list-icon {
      opacity: 1;
    }

    .list-item-label {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-delete-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--gray-400);
      flex-shrink: 0;
      line-height: 0;
    }

    .list-delete-btn:hover {
      color: var(--red);
      background: #fee2e2;
    }

    .list-delete-btn svg {
      width: 14px;
      height: 14px;
    }

    .list-item:hover .list-delete-btn {
      display: block;
    }

    /* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      min-width: 0;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .list-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    /* â”€â”€â”€ Add task form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-task-form {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: none;
    }

    .add-task-form.visible {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .input {
      flex: 1;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.9rem;
      color: var(--gray-900);
      transition: border-color 0.15s;
      font-family: inherit;
    }

    .input:focus {
      outline: none;
      border-color: var(--indigo);
    }

    textarea.input {
      resize: vertical;
      min-height: 70px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 9px 18px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--indigo);
      color: white;
    }

    .btn-primary:hover {
      background: var(--indigo-dark);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-add {
      background: var(--indigo);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s;
      font-family: inherit;
    }

    .btn-add:hover {
      background: var(--indigo-dark);
    }

    /* â”€â”€â”€ Task list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: box-shadow 0.15s;
    }

    .task-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .task-card.completed {
      opacity: 0.55;
    }

    .task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-200);
      border-radius: 50%;
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      margin-top: 2px;
    }

    .task-checkbox:hover {
      border-color: var(--green);
    }

    .task-card.completed .task-checkbox {
      background: var(--green);
      border-color: var(--green);
    }

    .task-checkbox svg {
      display: none;
    }

    .task-card.completed .task-checkbox svg {
      display: block;
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 0.95rem;
      color: var(--gray-900);
      line-height: 1.4;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
    }

    .task-notes {
      font-size: 0.8rem;
      color: var(--gray-400);
      margin-top: 3px;
      white-space: pre-wrap;
    }

    .task-due {
      font-size: 0.75rem;
      color: var(--gray-400);
      margin-top: 4px;
    }

    .task-due.overdue {
      color: var(--red);
    }

    .task-due.due-today {
      color: #d97706;
      font-weight: 600;
    }

    .task-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .task-card:hover .task-actions {
      opacity: 1;
    }

    .icon-btn {
      background: none;
      border: none;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-400);
      transition: all 0.15s;
      display: flex;
      align-items: center;
    }

    .icon-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .icon-btn.delete:hover {
      background: #fee2e2;
      color: var(--red);
    }

    .move-btns {
      display: flex;
      flex-direction: column;
      gap: 1px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .task-card:hover .move-btns {
      opacity: 1;
    }

    .move-btn {
      background: none;
      border: none;
      padding: 2px 4px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--gray-400);
      display: flex;
      align-items: center;
      transition: all 0.15s;
      line-height: 0;
    }

    .move-btn:hover:not(:disabled) {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .move-btn:disabled {
      opacity: 0.25;
      cursor: default;
    }

    .move-btn svg {
      width: 14px;
      height: 14px;
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* â”€â”€â”€ Empty / Loading states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-msg {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
    }

    .state-msg .emoji {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .state-msg p {
      font-size: 0.95rem;
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-backdrop.hidden {
      display: none;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .modal-field {
      margin-bottom: 14px;
    }

    .modal-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-500);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* â”€â”€â”€ Toasts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 200;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
      max-width: 360px;
      pointer-events: none;
    }

    .toast {
      background: var(--gray-900);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.875rem;
      line-height: 1.4;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      animation: toast-in 0.25s ease-out;
      pointer-events: auto;
    }

    .toast.success { background: #15803d; }
    .toast.error { background: #b91c1c; }

    @keyframes toast-in {
      from { transform: translateX(120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* â”€â”€â”€ Mobile menu button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-menu {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: var(--gray-700);
      align-items: center;
    }

    .btn-menu:hover { background: var(--gray-100); }
    .btn-menu svg { width: 20px; height: 20px; }

    /* â”€â”€â”€ Sidebar close button (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar-close-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      color: var(--gray-400);
      align-items: center;
    }

    .sidebar-close-btn:hover { background: var(--gray-100); color: var(--gray-700); }
    .sidebar-close-btn svg { width: 18px; height: 18px; }

    /* â”€â”€â”€ Sidebar backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 50;
    }

    .sidebar-backdrop.visible { display: block; }

    /* â”€â”€â”€ Rename list button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .list-rename-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--gray-400);
      flex-shrink: 0;
      line-height: 0;
    }

    .list-rename-btn:hover {
      color: var(--indigo);
      background: var(--indigo-light);
    }

    .list-rename-btn svg { width: 13px; height: 13px; }
    .list-item:hover .list-rename-btn { display: block; }

    /* â”€â”€â”€ Filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .filter-bar .input {
      flex: 1;
      min-width: 0;
    }

    .filter-tabs {
      display: flex;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .filter-tab {
      background: none;
      border: none;
      padding: 8px 14px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .filter-tab:not(:last-child) {
      border-right: 1px solid var(--gray-200);
    }

    .filter-tab.active {
      background: var(--indigo);
      color: white;
    }

    .filter-tab:not(.active):hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .btn-menu { display: flex; }
      .sidebar-close-btn { display: flex; }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        background: white;
        z-index: 60;
        padding: 16px;
        overflow-y: auto;
        box-shadow: 2px 0 16px rgba(0,0,0,0.15);
        transform: translateX(-100%);
        transition: transform 0.25s ease-out;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .layout { padding: 16px; }
    }
  
    /* List count badge */
    .list-count {
      background: rgba(99,102,241,0.12);
      color: var(--indigo);
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 8px;
      flex-shrink: 0;
    }
    .list-item.active .list-count {
      background: var(--indigo);
      color: white;
    }

</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <button class="btn-menu" onclick="openMobileSidebar()" title="Open menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <div class="logo">Tasklr</div>
  </div>
  <div class="user-area">
    <img id="user-avatar" class="user-avatar" src="" alt="" style="display:none">
    <span id="user-name" class="user-name"></span>
    <form method="POST" action="/auth/logout">
      <button type="submit" class="btn-logout">Sign out</button>
    </form>
  </div>
</header>

<div id="sidebar-backdrop" class="sidebar-backdrop" onclick="closeMobileSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">My Lists</div>
      <div style="display:flex;gap:2px;align-items:center">
        <button class="sidebar-close-btn" onclick="closeMobileSidebar()" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <button class="btn-new-list" onclick="toggleNewListForm()" title="New list">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
    </div>
    <div id="new-list-form" class="new-list-form">
      <input id="new-list-name" class="input" type="text" placeholder="List name" autocomplete="off">
      <div class="new-list-form-actions">
        <button class="btn btn-secondary" onclick="toggleNewListForm()">Cancel</button>
        <button class="btn btn-primary" onclick="createList()">Create</button>
      </div>
    </div>
    <div id="sidebar-lists">
      <div class="state-msg" style="padding:20px 0">
        <p>Loading...</p>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="main-header">
      <h1 id="list-title" class="list-title">Select a list</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btn-clear-completed" class="btn btn-secondary" onclick="clearCompleted()" style="display:none;font-size:0.8rem;padding:8px 14px">
          Clear completed
        </button>
        <button id="btn-add-task" class="btn-add" onclick="toggleAddForm()" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Task
        </button>
      </div>
    </div>

    <div id="add-task-form" class="add-task-form">
      <div class="form-row">
        <input id="new-task-title" class="input" type="text" placeholder="Task title" autocomplete="off">
      </div>
      <div class="form-row">
        <textarea id="new-task-notes" class="input" placeholder="Notes (optional)"></textarea>
      </div>
      <div class="form-row">
        <input id="new-task-due" class="input" type="date" placeholder="Due date (optional)">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="toggleAddForm()">Cancel</button>
        <button class="btn btn-primary" onclick="createTask()">Add Task</button>
      </div>
    </div>

    <div id="filter-bar" class="filter-bar" style="display:none">
      <input type="search" id="search-input" class="input" placeholder="Search tasks..."
             oninput="setSearch(this.value)" autocomplete="off">
      <div class="filter-tabs">
        <button class="filter-tab active" id="filter-all" onclick="setFilter('all')">All</button>
        <button class="filter-tab" id="filter-active" onclick="setFilter('active')">Active</button>
        <button class="filter-tab" id="filter-completed" onclick="setFilter('completed')">Completed</button>
      </div>
    </div>

    <div id="task-list" class="task-list">
      <div class="state-msg">
        <div class="emoji">â˜‘ï¸</div>
        <p>Select a task list from the sidebar to get started.</p>
      </div>
    </div>
  </main>
</div>

<div id="toast-container"></div>

<!-- Edit modal -->
<div id="edit-modal" class="modal-backdrop hidden">
  <div class="modal">
    <h2 class="modal-title">Edit Task</h2>
    <div class="modal-field">
      <label>Title</label>
      <input id="edit-title" class="input" type="text" style="width:100%">
    </div>
    <div class="modal-field">
      <label>Notes</label>
      <textarea id="edit-notes" class="input" style="width:100%"></textarea>
    </div>
    <div class="modal-field">
      <label>Due Date</label>
      <input id="edit-due" class="input" type="date" style="width:100%">
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<script>
  let currentListId = null;
  let currentTasks = [];
  let editingTaskId = null;
  let searchQuery = '';
  let statusFilter = 'all';

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    try {
      const [user, lists] = await Promise.all([
        fetch('/api/me').then(r => r.json()),
        fetch('/api/tasklists').then(r => r.json()),
      ]);

      if (user.name) {
        document.getElementById('user-name').textContent = user.name;
      }
      if (user.picture) {
        const img = document.getElementById('user-avatar');
        img.src = user.picture;
        img.style.display = 'block';
      }

      renderSidebar(lists);

      // Auto-select first list
      if (lists.length > 0) {
        selectList(lists[0].id, lists[0].title);
      }
    } catch (err) {
      console.error('Init error:', err);
    }
  }

  // â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSidebar(lists) {
    const container = document.getElementById('sidebar-lists');
    if (!lists.length) {
      container.innerHTML = '<div class="state-msg" style="padding:20px 0"><p>No lists yet. Create one!</p></div>';
      return;
    }
    container.innerHTML = lists.map(list => `
      <button class="list-item" id="list-btn-${list.id}" onclick="selectList('${list.id}', '${escHtml(list.title)}')">
        <svg class="list-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
        </svg>
        <span class="list-item-label">${escHtml(list.title)}</span>
        <span class="list-count" id="list-count-${list.id}">...</span>
        <button class="list-rename-btn" onclick="startRenameList(event, '${list.id}', '${escHtml(list.title)}')" title="Rename list">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </button>
        <button class="list-delete-btn" onclick="deleteList(event, '${list.id}', '${escHtml(list.title)}')" title="Delete list">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
            <path d="M10 11v6M14 11v6"></path>
            <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
          </svg>
        </button>
      </button>
    `).join('');
    updateListCounts(lists);
  }

  // â”€â”€â”€ New list form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleNewListForm() {
    const form = document.getElementById('new-list-form');
    form.classList.toggle('visible');
    if (form.classList.contains('visible')) {
      document.getElementById('new-list-name').value = '';
      document.getElementById('new-list-name').focus();
    }
  }

  async function createList() {
    const title = document.getElementById('new-list-name').value.trim();
    if (!title) {
      document.getElementById('new-list-name').focus();
      return;
    }
    try {
      const res = await fetch('/api/tasklists', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title }),
      });
      if (!res.ok) throw new Error('Failed');
      const newList = await res.json();
      toggleNewListForm();
      // Reload sidebar lists
      const lists = await fetch('/api/tasklists').then(r => r.json());
      renderSidebar(lists);
      // Select the newly created list
      selectList(newList.id, newList.title);
      showToast('List created', 'success');
    } catch (err) {
      showToast('Failed to create list. Please try again.', 'error');
    }
  }

  async function deleteList(event, listId, listTitle) {
    event.stopPropagation();
    if (!confirm(`Delete the list "${listTitle}" and all its tasks?`)) return;
    try {
      const res = await fetch(`/api/tasklists/${listId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Failed');
      // Reload sidebar
      const lists = await fetch('/api/tasklists').then(r => r.json());
      renderSidebar(lists);
      // If the deleted list was active, reset the main area
      if (currentListId === listId) {
        currentListId = null;
        document.getElementById('list-title').textContent = 'Select a list';
        document.getElementById('btn-add-task').disabled = true;
        document.getElementById('btn-clear-completed').style.display = 'none';
        document.getElementById('add-task-form').classList.remove('visible');
        document.getElementById('filter-bar').style.display = 'none';
        document.getElementById('task-list').innerHTML = `
          <div class="state-msg">
            <div class="emoji">â˜‘ï¸</div>
            <p>Select a task list from the sidebar to get started.</p>
          </div>
        `;
        if (lists.length > 0) {
          selectList(lists[0].id, lists[0].title);
        }
      }
      showToast('List deleted', 'success');
    } catch (err) {
      showToast('Failed to delete list. Please try again.', 'error');
    }
  }

  async function selectList(listId, title) {
    currentListId = listId;
    document.getElementById('list-title').textContent = title;
    document.getElementById('btn-add-task').disabled = false;

    // Reset search and filter state when switching lists
    searchQuery = '';
    statusFilter = 'all';
    document.getElementById('search-input').value = '';
    document.querySelectorAll('.filter-tab').forEach(btn => {
      btn.classList.toggle('active', btn.id === 'filter-all');
    });
    document.getElementById('filter-bar').style.display = 'flex';

    // Update sidebar active state
    document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
    const activeBtn = document.getElementById(`list-btn-${listId}`);
    if (activeBtn) activeBtn.classList.add('active');

    // Close add form and mobile sidebar
    document.getElementById('add-task-form').classList.remove('visible');
    closeMobileSidebar();

    await loadTasks(listId);
  }

  // â”€â”€â”€ Search & filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getFilteredTasks() {
    let tasks = currentTasks;
    if (statusFilter === 'active') {
      tasks = tasks.filter(t => t.status !== 'completed');
    } else if (statusFilter === 'completed') {
      tasks = tasks.filter(t => t.status === 'completed');
    }
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      tasks = tasks.filter(t =>
        (t.title || '').toLowerCase().includes(q) ||
        (t.notes || '').toLowerCase().includes(q)
      );
    }
    return tasks;
  }

  function applyFilters() {
    renderTasks(getFilteredTasks());
  }

  function setSearch(query) {
    searchQuery = query;
    applyFilters();
  }

  function setFilter(filter) {
    statusFilter = filter;
    document.querySelectorAll('.filter-tab').forEach(btn => {
      btn.classList.toggle('active', btn.id === `filter-${filter}`);
    });
    applyFilters();
  }

  // â”€â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadTasks(listId) {
    const container = document.getElementById('task-list');
    container.innerHTML = '<div class="state-msg"><p>Loading tasks...</p></div>';
    try {
      const tasks = await fetch(`/api/tasklists/${listId}/tasks`).then(r => r.json());
      currentTasks = tasks;
      applyFilters();
    } catch (err) {
      container.innerHTML = '<div class="state-msg"><p>Failed to load tasks.</p></div>';
    }
  }

  // â”€â”€â”€ Due date label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatDueDate(dueDate, isCompleted) {
    if (!dueDate) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(dueDate);
    due.setHours(0, 0, 0, 0);
    const diffDays = Math.round((due - today) / (1000 * 60 * 60 * 24));

    let label, cls = 'task-due';
    if (diffDays < -1) {
      label = `${Math.abs(diffDays)} days overdue`;
      if (!isCompleted) cls += ' overdue';
    } else if (diffDays === -1) {
      label = 'Yesterday';
      if (!isCompleted) cls += ' overdue';
    } else if (diffDays === 0) {
      label = 'Due today';
      if (!isCompleted) cls += ' due-today';
    } else if (diffDays === 1) {
      label = 'Due tomorrow';
    } else if (diffDays <= 7) {
      label = `Due in ${diffDays} days`;
    } else {
      label = `Due ${due.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}`;
    }
    return { label, cls };
  }

  function renderTasks(tasks) {
    const container = document.getElementById('task-list');
    const needsAction = tasks.filter(t => t.status !== 'completed');
    const completed = tasks.filter(t => t.status === 'completed');
    const ordered = [...needsAction, ...completed];

    // Show/hide clear completed button (based on all tasks, not just the filtered set)
    const clearBtn = document.getElementById('btn-clear-completed');
    const hasCompleted = currentTasks.some(t => t.status === 'completed');
    clearBtn.style.display = hasCompleted ? 'inline-flex' : 'none';

    if (!ordered.length) {
      const isFiltered = searchQuery || statusFilter !== 'all';
      container.innerHTML = `
        <div class="state-msg">
          <div class="emoji">${isFiltered ? 'ğŸ”' : 'âœ…'}</div>
          <p>${isFiltered ? 'No tasks match your search.' : 'No tasks yet. Add one above!'}</p>
        </div>
      `;
      return;
    }

    container.innerHTML = ordered.map((task, idx) => {
      const isCompleted = task.status === 'completed';
      const dueInfo = task.due ? formatDueDate(task.due, isCompleted) : null;

      // Move buttons: only for needsAction tasks
      const naIndex = needsAction.indexOf(task);
      const canMoveUp = !isCompleted && naIndex > 0;
      const canMoveDown = !isCompleted && naIndex < needsAction.length - 1;
      const moveBtns = isCompleted ? '' : `
        <div class="move-btns">
          <button class="move-btn" onclick="moveTask('${task.id}', 'up')" title="Move up" ${canMoveUp ? '' : 'disabled'}>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
          </button>
          <button class="move-btn" onclick="moveTask('${task.id}', 'down')" title="Move down" ${canMoveDown ? '' : 'disabled'}>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
        </div>
      `;

      return `
        <div class="task-card ${isCompleted ? 'completed' : ''}" id="task-${task.id}">
          ${moveBtns}
          <div class="task-checkbox" onclick="toggleComplete('${task.id}', ${isCompleted})">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="12" height="12">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <div class="task-content">
            <div class="task-title">${escHtml(task.title || '(No title)')}</div>
            ${task.notes ? `<div class="task-notes">${escHtml(task.notes)}</div>` : ''}
            ${dueInfo ? `<div class="${dueInfo.cls}">${dueInfo.label}</div>` : ''}
          </div>
          <div class="task-actions">
            <button class="icon-btn" onclick="openEditModal('${task.id}')" title="Edit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="icon-btn delete" onclick="deleteTask('${task.id}')" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6M14 11v6"></path>
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
              </svg>
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  // â”€â”€â”€ Add task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleAddForm() {
    const form = document.getElementById('add-task-form');
    form.classList.toggle('visible');
    if (form.classList.contains('visible')) {
      document.getElementById('new-task-title').focus();
    } else {
      clearAddForm();
    }
  }

  function clearAddForm() {
    document.getElementById('new-task-title').value = '';
    document.getElementById('new-task-notes').value = '';
    document.getElementById('new-task-due').value = '';
  }

  async function createTask() {
    const title = document.getElementById('new-task-title').value.trim();
    if (!title) {
      document.getElementById('new-task-title').focus();
      return;
    }
    const notes = document.getElementById('new-task-notes').value.trim();
    const due = document.getElementById('new-task-due').value;

    try {
      const res = await fetch(`/api/tasklists/${currentListId}/tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, notes, due }),
      });
      if (!res.ok) throw new Error('Failed');
      clearAddForm();
      document.getElementById('add-task-form').classList.remove('visible');
      await loadTasks(currentListId);
      showToast('Task added', 'success');
    } catch (err) {
      showToast('Failed to create task. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Toggle complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function toggleComplete(taskId, isCompleted) {
    try {
      const newStatus = isCompleted ? 'needsAction' : 'completed';
      await fetch(`/api/tasklists/${currentListId}/tasks/${taskId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });
      await loadTasks(currentListId);
    } catch (err) {
      showToast('Failed to update task. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Delete task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function deleteTask(taskId) {
    if (!confirm('Delete this task?')) return;
    try {
      await fetch(`/api/tasklists/${currentListId}/tasks/${taskId}`, { method: 'DELETE' });
      await loadTasks(currentListId);
      showToast('Task deleted', 'success');
    } catch (err) {
      showToast('Failed to delete task. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Move task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function moveTask(taskId, direction) {
    const needsAction = currentTasks.filter(t => t.status !== 'completed');
    const idx = needsAction.findIndex(t => t.id === taskId);
    if (idx === -1) return;

    let previous; // undefined = not sending (move to top); string = task id before new position
    if (direction === 'up') {
      if (idx === 0) return;
      // Move to position idx-1 means new previous is task at idx-2 (or null for top)
      previous = idx >= 2 ? needsAction[idx - 2].id : null;
    } else {
      if (idx >= needsAction.length - 1) return;
      // Move to position idx+1 means new previous is task at idx+1
      previous = needsAction[idx + 1].id;
    }

    try {
      const res = await fetch(`/api/tasklists/${currentListId}/tasks/${taskId}/move`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ previous }),
      });
      if (!res.ok) throw new Error('Failed');
      await loadTasks(currentListId);
    } catch (err) {
      showToast('Failed to move task. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Clear completed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function clearCompleted() {
    if (!confirm('Remove all completed tasks from this list?')) return;
    try {
      const res = await fetch(`/api/tasklists/${currentListId}/clear`, { method: 'POST' });
      if (!res.ok) throw new Error('Failed');
      await loadTasks(currentListId);
      showToast('Completed tasks cleared', 'success');
    } catch (err) {
      showToast('Failed to clear completed tasks. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openEditModal(taskId) {
    const task = currentTasks.find(t => t.id === taskId);
    if (!task) return;
    editingTaskId = taskId;
    document.getElementById('edit-title').value = task.title || '';
    document.getElementById('edit-notes').value = task.notes || '';
    document.getElementById('edit-due').value = task.due ? task.due.split('T')[0] : '';
    document.getElementById('edit-modal').classList.remove('hidden');
    document.getElementById('edit-title').focus();
  }

  function closeEditModal() {
    editingTaskId = null;
    document.getElementById('edit-modal').classList.add('hidden');
  }

  async function saveEdit() {
    const title = document.getElementById('edit-title').value.trim();
    if (!title) {
      document.getElementById('edit-title').focus();
      return;
    }
    const notes = document.getElementById('edit-notes').value.trim();
    const due = document.getElementById('edit-due').value;

    try {
      await fetch(`/api/tasklists/${currentListId}/tasks/${editingTaskId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, notes, due }),
      });
      closeEditModal();
      await loadTasks(currentListId);
      showToast('Task saved', 'success');
    } catch (err) {
      showToast('Failed to save changes. Please try again.', 'error');
    }
  }

  // â”€â”€â”€ Mobile sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openMobileSidebar() {
    document.querySelector('.sidebar').classList.add('open');
    document.getElementById('sidebar-backdrop').classList.add('visible');
    document.body.style.overflow = 'hidden';
  }

  function closeMobileSidebar() {
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebar-backdrop').classList.remove('visible');
    document.body.style.overflow = '';
  }

  // â”€â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(message, type = 'info', duration = 3500) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.transition = 'opacity 0.3s';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // â”€â”€â”€ List rename â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startRenameList(event, listId, currentTitle) {
    event.stopPropagation();
    const btn = document.getElementById(`list-btn-${listId}`);
    if (!btn) return;
    const label = btn.querySelector('.list-item-label');

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'input';
    input.style.cssText = 'padding:3px 8px;font-size:0.875rem;height:auto;width:100%;';
    input.value = currentTitle;

    label.textContent = '';
    label.appendChild(input);
    input.focus();
    input.select();

    let saved = false;

    const save = async () => {
      if (saved) return;
      saved = true;
      await saveRenameList(listId, input.value);
    };

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); save(); }
      else if (e.key === 'Escape') {
        saved = true;
        fetch('/api/tasklists').then(r => r.json()).then(lists => renderSidebar(lists));
      }
    });

    input.addEventListener('blur', save);
  }

  async function saveRenameList(listId, newTitle) {
    const title = newTitle.trim();
    if (!title) {
      const lists = await fetch('/api/tasklists').then(r => r.json());
      renderSidebar(lists);
      return;
    }
    try {
      const res = await fetch(`/api/tasklists/${listId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title }),
      });
      if (!res.ok) throw new Error('Failed');
      const lists = await fetch('/api/tasklists').then(r => r.json());
      renderSidebar(lists);
      if (currentListId === listId) {
        document.getElementById('list-title').textContent = title;
      }
      showToast('List renamed', 'success');
    } catch (err) {
      showToast('Failed to rename list. Please try again.', 'error');
      const lists = await fetch('/api/tasklists').then(r => r.json());
      renderSidebar(lists);
    }
  }

  // â”€â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeEditModal();
      document.getElementById('add-task-form').classList.remove('visible');
      document.getElementById('new-list-form').classList.remove('visible');
    }
    if (e.key === 'Enter') {
      if (document.getElementById('add-task-form').classList.contains('visible') && document.activeElement.id === 'new-task-title') {
        createTask();
      }
      if (document.getElementById('new-list-form').classList.contains('visible') && document.activeElement.id === 'new-list-name') {
        createList();
      }
    }
    // 'n' to open add task form (when not typing in an input)
    if (e.key === 'n') {
      const inInput = e.target.matches('input, textarea, [contenteditable]');
      const modalOpen = !document.getElementById('edit-modal').classList.contains('hidden');
      const addFormOpen = document.getElementById('add-task-form').classList.contains('visible');
      if (!inInput && !modalOpen && !addFormOpen && currentListId) {
        e.preventDefault();
        toggleAddForm();
      }
    }
  });

  // â”€â”€â”€ Close modal on backdrop click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('edit-modal').addEventListener('click', e => {
    if (e.target === document.getElementById('edit-modal')) closeEditModal();
  });

  // â”€â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }


  // â”€â”€â”€ Sidebar counts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateListCounts(lists) {
  try {
    const res = await fetch('/api/tasklists/counts');
    if (!res.ok) throw new Error('Failed to fetch counts');
    const counts = await res.json();
    for (const list of lists) {
      const el = document.getElementById(`list-count-${list.id}`);
      if (!el) continue;
      const c = counts[list.id] || 0;
      el.textContent = c > 0 ? String(c) : '';
      el.title = `${c} incomplete task${c === 1 ? '' : 's'}`;
    }
  } catch (err) {
    // Fallback: attempt per-list fetch if summary endpoint fails
    for (const list of lists) {
      await updateListCount(list.id);
    }
  }
}

async function updateListCount(listId) {
  const el = document.getElementById(`list-count-${listId}`);
  if (!el) return;
  try {
    const tasks = await fetch(`/api/tasklists/${listId}/tasks`).then(r => r.json());
    const incomplete = tasks.filter(t => t.status !== 'completed').length;
    el.textContent = incomplete > 0 ? String(incomplete) : '';
    el.title = `${incomplete} incomplete task${incomplete === 1 ? '' : 's'}`;
  } catch (err) {
    el.textContent = '';
  }
}


  init();
</script>
</body>
</html>
